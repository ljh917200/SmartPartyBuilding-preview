var Ee=Object.defineProperty;var we=(u,o,f)=>o in u?Ee(u,o,{enumerable:!0,configurable:!0,writable:!0,value:f}):u[o]=f;var z=(u,o,f)=>we(u,typeof o!="symbol"?o+"":o,f);import{h as q,Z,r as h,G as U,q as N,c as d,o as c,C as M,f as l,j as C,t as y,_ as Q,n as j,O as ke,ad as Ce,s as be,ae as xe,K as $e,a as Ne,b as Me,af as Le,F as $,i as O,g as Re,I as Se,k as Ve}from"./index-G-qDTFo-.js";const Ie=["data-department-id"],Be={class:"node-header"},ze={class:"node-name"},Oe={key:0,class:"member-count"},Ue={class:"node-actions"},Ye={class:"expand-section"},Fe={key:0,class:"leaf-indicator"},Ge={key:1,class:"loading-indicator"},He=q({__name:"DepartmentNode",props:{department:{},level:{}},emits:["viewDetail","delete","updatePosition"],setup(u,{emit:o}){const f=u,p=o,_=Z(()=>f.department.hasChildren&&!f.department.isLeaf),T=h();U(()=>{T.value&&N(()=>{p("updatePosition",f.department.id,T.value)})});const w=P=>{P.stopPropagation(),p("viewDetail",f.department)},D=P=>{P.stopPropagation(),p("delete",f.department)};return(P,b)=>(c(),d("div",{class:M(["department-node",[`level-${u.level}`]]),"data-department-id":u.department.id,ref_key:"nodeElement",ref:T},[l("div",{class:M(["node-card",{loading:u.department.loading}])},[l("div",Be,[l("span",ze,y(u.department.departmentName),1),u.department.memberCount!==void 0?(c(),d("span",Oe," ("+y(u.department.memberCount)+"人) ",1)):C("",!0)]),l("div",Ue,[l("div",{class:"action-buttons"},[l("button",{class:"action-btn detail-btn",onClick:w},"详情"),l("button",{class:"action-btn delete-btn",onClick:D},"删除")]),l("div",Ye,[!_.value&&!u.department.loading?(c(),d("span",Fe,"末级")):C("",!0),u.department.loading?(c(),d("span",Ge,"加载中...")):C("",!0)])])],2)],10,Ie))}}),Ae=Q(He,[["__scopeId","data-v-65ebe54b"]]),Je={class:"department-tree-container"},Ke={class:"toolbar"},We={class:"search-box"},Xe={class:"stats"},je={key:0,class:"loading-placeholder"},qe={class:"loading"},Ze={key:1,class:"empty-placeholder"},Qe={key:2,class:"mindmap-container"},et={class:"connections-svg",width:"100%",height:"100%"},tt=["d","data-level","onMouseenter"],nt={class:"horizontal-layout"},at={class:"dialog-body"},ot={key:0,class:"loading"},st={key:1,class:"department-detail"},lt={class:"detail-item"},rt={class:"detail-item"},it={class:"detail-item"},ct=q({__name:"index",setup(u){const o=h([]),f=h({}),p=h(null),_=h(""),T=h([]),w=h(!1),D=h(null),P=h(!1),b=h(null),L=h(!1),x=h(!1),R=h({current:0,total:0,message:"正在加载部门数据..."}),Y=h("auto-expanded"),S=Z(()=>{let t=0,e=0,n=o.value.length;const a=s=>{s&&s.forEach(r=>{t++,e+=r.memberCount||0})};return o.value.forEach(s=>a(s)),{totalDepartments:t,totalMembers:e,maxDepth:n}});class ee{constructor(){z(this,"nodePositions",new Map);z(this,"connections",[])}registerNode(e,n,a,s){try{const r=n.left-s.left+n.width/2,g=n.top-s.top+n.height/2;this.nodePositions.set(e,{x:r,y:g,id:e,level:a})}catch(r){console.warn(`注册节点 ${e} 位置失败:`,r)}}calculateParentChildConnections(e){this.connections=[];for(let n=0;n<e.length-1;n++)e[n].forEach(s=>{s.expanded&&s.children&&s.children.forEach(r=>{const g=this.nodePositions.get(s.id),m=this.nodePositions.get(r.id);if(g&&m){const E=this.createSmoothConnection(g,m);this.connections.push({id:`${s.id}-${r.id}`,from:g,to:m,path:E,type:"parent-child"})}})})}createSmoothConnection(e,n){const a=n.x-e.x;n.y-e.y;const s={x:e.x+a*.3,y:e.y},r={x:n.x-a*.3,y:n.y};return`M ${e.x} ${e.y} 
            C ${s.x} ${s.y}, 
              ${r.x} ${r.y}, 
              ${n.x} ${n.y}`}getConnections(){return this.connections}clear(){this.connections=[]}getNodePositions(){return this.nodePositions}validateConnection(e){return!!(this.nodePositions.get(e.from.id)&&this.nodePositions.get(e.to.id))}}const te=()=>{const t=new Map,e=new ee;return{trackNode:(s,r,g)=>{if(!p.value)return;const m=()=>{const E=r.getBoundingClientRect(),Te=p.value.getBoundingClientRect();e.registerNode(s,E,g,Te)};if(m(),window.ResizeObserver){const E=new ResizeObserver(m);E.observe(r),t.set(s,E)}},untrackNode:s=>{const r=t.get(s);r&&(r.disconnect(),t.delete(s))},connectionManager:e}},{trackNode:ne,untrackNode:ae,connectionManager:F}=te(),oe=()=>{p.value&&N(()=>{F.calculateParentChildConnections(o.value),T.value=F.getConnections()})};let k=null;const v=()=>{k&&clearTimeout(k),k=window.setTimeout(oe,50)},i=(t,e,n=!1)=>({id:t,departmentName:e,fatherDepartmentId:"-1",hasChildren:n,isLeaf:!n,memberCount:Math.floor(Math.random()*50)+1,loading:!1,expanded:!1}),V=async(t=!0,e)=>{if(e)return[i("DEPT_001","技术部",!0),i("DEPT_002","人事部",!0),i("DEPT_003","市场部",!0),i("DEPT_004","财务部",!1),i("DEPT_011","前端组",!0),i("DEPT_012","后端组",!0),i("DEPT_013","测试组",!1),i("DEPT_021","招聘组",!1),i("DEPT_022","培训组",!1),i("DEPT_031","线上运营组",!1),i("DEPT_032","线下活动组",!1),i("DEPT_0111","Vue小组",!1),i("DEPT_0112","React小组",!1),i("DEPT_0121","Java小组",!1),i("DEPT_0122","Go小组",!1)].filter(s=>s.departmentName.includes(e));const n=[i("DEPT_001","技术部",!0),i("DEPT_002","人事部",!0),i("DEPT_003","市场部",!0),i("DEPT_004","财务部",!1)];if(t)for(const a of n)await G(a,0);return n},G=async(t,e)=>{if(t.hasChildren){t.loading=!0;try{const n=await H(t.id);t.children=n,t.expanded=!0;for(const a of n)await G(a,e+1)}catch(n){console.error(`加载 ${t.departmentName} 的子部门失败:`,n)}finally{t.loading=!1}}},H=async t=>{switch(t){case"DEPT_001":return[i("DEPT_011","前端组",!0),i("DEPT_012","后端组",!0),i("DEPT_013","测试组",!1)];case"DEPT_002":return[i("DEPT_021","招聘组",!1),i("DEPT_022","培训组",!1)];case"DEPT_003":return[i("DEPT_031","线上运营组",!1),i("DEPT_032","线下活动组",!1)];case"DEPT_011":return[i("DEPT_0111","Vue小组",!1),i("DEPT_0112","React小组",!1)];case"DEPT_012":return[i("DEPT_0121","Java小组",!1),i("DEPT_0122","Go小组",!1)];default:return[]}},se=async t=>{P.value=!0;try{await new Promise(n=>setTimeout(n,500));const e=i(t,`部门${t}`,!1);D.value=e,w.value=!0}catch(e){console.error("获取部门详情失败:",e)}finally{P.value=!1}},le=async t=>{try{return await new Promise(e=>setTimeout(e,500)),console.log("部门删除成功:",t),!0}catch(e){return console.error("删除部门失败:",e),!1}},A=async()=>{const t=[],e=await V(!0);return t[0]=e,await I(e,1,t),t},I=async(t,e,n)=>{if(!t.length)return;const a=[];for(const s of t)s.children&&s.children.length>0&&a.push(...s.children);a.length>0&&(n[e]=a,await I(a,e+1,n))},re=async t=>{const e=[];return e[0]=t,_.value&&await I(t,1,e),e},ie=async(t,e)=>{if(Y.value==="auto-expanded"&&(Y.value="user-controlled"),t.loading)return;const n=t.id;t.expanded?await de(t,e):await ce(t,e),N(()=>{v(),t.expanded&&ue(n)})},ce=async(t,e)=>{t.loading=!0;try{if(t.children&&t.children.length>0)t.expanded=!0,K(t.children,e+1);else{const n=await H(t.id);t.children=n,t.expanded=!0,K(n,e+1)}}catch(n){console.error(`展开 ${t.departmentName} 失败:`,n),t.expanded=!1}finally{t.loading=!1}},de=async(t,e)=>{t.expanded=!1,fe(t.id,e)},ue=t=>{const e=f.value[t];if(!e||!p.value)return;const n=p.value,a=e.getBoundingClientRect(),s=n.getBoundingClientRect(),r=e.offsetLeft-s.width/2+a.width/2;n.scrollTo({left:Math.max(0,r),behavior:"smooth"})},fe=(t,e)=>{var n;if(e+1<o.value.length){const a=o.value[e].find(r=>r.id===t),s=((n=a==null?void 0:a.children)==null?void 0:n.map(r=>r.id))||[];s.length>0&&(o.value[e+1]=o.value[e+1].filter(r=>!s.includes(r.id)),o.value[e+1].length===0?o.value=o.value.slice(0,e+1):J(s,e+1))}},J=(t,e)=>{if(e+1>=o.value.length)return;const n=[];o.value[e].forEach(a=>{t.includes(a.fatherDepartmentId)&&a.children&&n.push(...a.children.map(s=>s.id))}),n.length>0&&(o.value[e+1]=o.value[e+1].filter(a=>!n.includes(a.id)),o.value[e+1].length===0?o.value=o.value.slice(0,e+1):J(n,e+1))},K=(t,e)=>{if(t.length>0){for(;o.value.length<=e;)o.value.push([]);o.value[e]=[...o.value[e]||[],...t]}},he=async t=>{await se(t.id)},ve=async(t,e,n)=>{if(await le([t.id])){if(o.value[e].splice(n,1),t.expanded&&t.children){const s=t.children.map(r=>r.id);e+1<o.value.length&&(o.value[e+1]=o.value[e+1].filter(r=>!s.includes(r.id)),o.value[e+1].length===0&&(o.value=o.value.slice(0,e+1)))}v()}},me=(t,e)=>{e&&e.$el&&(f.value[t]=e.$el)},pe=(t,e)=>{let n=-1;for(let a=0;a<o.value.length;a++)if(o.value[a].some(s=>s.id===t)){n=a;break}n!==-1&&ne(t,e,n)};j(()=>o.value,()=>{v()},{deep:!0,immediate:!0}),U(()=>{window.addEventListener("resize",v)}),ke(()=>{Object.keys(f.value).forEach(t=>{ae(t)}),k&&clearTimeout(k),window.removeEventListener("resize",v)}),U(async()=>{try{const t=await A();o.value=t,v(),N(()=>{ge()})}catch(t){console.error("初始化部门树失败:",t);const e=await V(!1);o.value=[e],v()}});const ge=()=>{document.querySelectorAll(".department-node").forEach((e,n)=>{const a=e;a.style.opacity="0",a.style.transform="translateY(20px)",setTimeout(()=>{a.style.transition="all 0.5s ease",a.style.opacity="1",a.style.transform="translateY(0)"},n*100)})},W=async()=>{L.value=!0;try{const t=await V(!1,_.value);_.value;const e=await re(t);o.value=e,v(),t.length===0&&(x.value=!0)}catch(t){X(t,"搜索部门"),o.value=[[]],x.value=!0,v()}finally{L.value=!1}},ye=async()=>{_.value="",x.value=!1;try{const t=await A();o.value=t,v()}catch(t){X(t,"重置部门数据"),o.value=[[]],v()}},X=(t,e)=>{console.error(`${e}失败:`,t)},_e=t=>{b.value=t},De=()=>{b.value=null},B=()=>{w.value=!1,D.value=null},Pe=()=>{const t={},e=n=>{n.forEach(a=>{t[a.id]=a.expanded||!1,a.children&&e(a.children)})};o.value.forEach(n=>e(n)),localStorage.setItem("departmentExpandedState",JSON.stringify(t))};return j(()=>o.value,()=>{Pe()},{deep:!0,immediate:!1}),(t,e)=>{const n=Me("el-empty");return c(),d($,null,[l("div",Je,[l("div",{class:"loading-progress",style:Ce({width:`${R.value.current/R.value.total*100}%`})},null,4),e[4]||(e[4]=l("h2",null,"部门组织结构图",-1)),l("div",Ke,[l("div",We,[be(l("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>_.value=a),placeholder:"搜索部门...",class:"search-input",onKeyup:$e(W,["enter"])},null,544),[[xe,_.value]]),l("button",{class:"search-button",onClick:W}," 搜索 "),l("button",{class:"reset-button",onClick:ye}," 重置 ")]),l("div",Xe,[l("span",null,"部门总数: "+y(S.value.totalDepartments),1),l("span",null,"成员总数: "+y(S.value.totalMembers),1),l("span",null,"最大层级: "+y(S.value.maxDepth),1)])]),l("div",{class:"tree-wrapper",ref_key:"treeContainerRef",ref:p},[L.value?(c(),d("div",je,[l("div",qe,y(R.value.message),1)])):x.value?(c(),d("div",Ze,[Ne(n,{description:"暂无相关部门数据"})])):(c(),d("div",Qe,[(c(),d("svg",et,[e[2]||(e[2]=Le('<defs data-v-2f05cf9c><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" data-v-2f05cf9c><polygon points="0 0, 10 3.5, 0 7" fill="#dcdfe6" data-v-2f05cf9c></polygon></marker><marker id="arrowhead-blue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" data-v-2f05cf9c><polygon points="0 0, 10 3.5, 0 7" fill="#409eff" data-v-2f05cf9c></polygon></marker><marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" data-v-2f05cf9c><polygon points="0 0, 10 3.5, 0 7" fill="#67c23a" data-v-2f05cf9c></polygon></marker></defs>',1)),(c(!0),d($,null,O(T.value,a=>(c(),d("path",{key:a.id,d:a.path,class:M(["connection-line",{"enter-active":!0,[`from-${a.from.id}`]:!0,[`to-${a.to.id}`]:!0,hovered:b.value===a.id}]),"data-level":a.from.level,onMouseenter:()=>_e(a.id),onMouseleave:De,fill:"none"},null,42,tt))),128))])),l("div",nt,[(c(!0),d($,null,O(o.value,(a,s)=>(c(),d("div",{key:s,class:M(["tree-level",`level-${s}`])},[(c(!0),d($,null,O(a,(r,g)=>(c(),Ve(Ae,{key:r.id,ref_for:!0,ref:m=>me(r.id,m),department:r,level:s,onExpand:m=>ie(m,s),onViewDetail:he,onDelete:m=>ve(r,s,g),onUpdatePosition:pe},null,8,["department","level","onExpand","onDelete"]))),128))],2))),128)),e[3]||(e[3]=Re("npm run build ",-1))])]))],512)]),w.value?(c(),d("div",{key:0,class:"dialog-overlay",onClick:B},[l("div",{class:"dialog",onClick:e[1]||(e[1]=Se(()=>{},["stop"]))},[l("div",{class:"dialog-header"},[e[5]||(e[5]=l("h3",null,"部门详情",-1)),l("button",{class:"close-btn",onClick:B},"×")]),l("div",at,[P.value?(c(),d("div",ot,"加载中...")):D.value?(c(),d("div",st,[l("div",lt,[e[6]||(e[6]=l("label",null,"部门ID:",-1)),l("span",null,y(D.value.id),1)]),l("div",rt,[e[7]||(e[7]=l("label",null,"部门名称:",-1)),l("span",null,y(D.value.departmentName),1)]),l("div",it,[e[8]||(e[8]=l("label",null,"上级部门ID:",-1)),l("span",null,y(D.value.fatherDepartmentId),1)])])):C("",!0)]),l("div",{class:"dialog-footer"},[l("button",{onClick:B},"关闭")])])])):C("",!0)],64)}}}),ft=Q(ct,[["__scopeId","data-v-2f05cf9c"]]);export{ft as default};
